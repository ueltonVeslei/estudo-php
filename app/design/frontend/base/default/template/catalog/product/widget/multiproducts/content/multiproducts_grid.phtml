<?php if (($_products = $this->getProductCollection()) && $_products->getSize()): ?>
<div class="widget widget-multi-products">
    <div class="widget-title">
        <h2><?php echo $this->getTitle(); ?></h2>
    </div>
    <div class="widget-products">
    <?php $_helper = $this->helper('catalog/output'); ?>
    <?php $_columnCount = 3 ?>
    <?php $_imgSize = 300; ?>
        <?php $i=0; foreach ($_products->getItems() as $_product): ?>
        <?php if ($i++%$_columnCount==0): ?>
        <ul class="products-grid">
        <?php endif ?>
            <li class="item<?php if(($i-1)%$_columnCount==0): ?> first<?php elseif($i%$_columnCount==0): ?> last<?php endif; ?>">
                <!-- INï¿½CIO SELOS -->
                <?php $_categoryIds = $_product->getCategoryIds(); ?>
                <?php if($_product->getFreteGratisDropdown()): ?>
                    <div class="frete_gratis_icon">
                        <a href="#frete-gratis-condicoes" class="open-modal">
                            <?php echo $_product->getAttributeText('frete_gratis_dropdown'); ?>
                        </a>
                    </div>
                <?php endif; ?>

                <?php if($_product->getPromo1()): ?>
                    <div class="selo_promo">
                        <?php echo $this->getLayout()->createBlock('cms/block')->setBlockId('promo1')->toHtml(); ?>
                    </div>
                <?php endif; ?>

                <?php if($_product->getPromo2()): ?>
                    <div class="selo_promo">
                        <?php echo $this->getLayout()->createBlock('cms/block')->setBlockId('promo2')->toHtml(); ?>
                    </div>
                <?php endif; ?>

                <?php if($_product->getPromo3()): ?>
                    <div class="selo_promo">
                        <?php echo $this->getLayout()->createBlock('cms/block')->setBlockId('promo3')->toHtml(); ?>
                    </div>
                <?php endif; ?>

                <?php if($_product->getPagueLeve()): ?>
                    <div class="frete_gratis_icon page_leve">
                        <?php echo $_product->getAttributeText('pague_leve'); ?>
                    </div>
                <?php endif; ?>

                <?php if($_discountPercentage > 0){  ?>
                    <div class="desconto_icon"><?php echo '' . $_discountPercentage . '%' ?></div>
                <?php }else{ ?>
                    <div style="background-color:#fff;font-size:0;" class="desconto_icon"><?php echo '-' . $_discountPercentage . '%' ?></div>
                <?php } ?>

                <!-- FIM SELOS -->
                <a href="<?php echo $_product->getProductUrl() ?>" title="<?php echo $this->stripTags($this->getImageLabel($_product, 'small_image'), null, true) ?>" class="product-image">
                    <?php if (in_array(26, $_categoryIds)): ?>
                        <?php echo $this->getLayout()->createBlock('cms/block')->setBlockId('medicamento-sem-imagem-controlados')->toHtml(); ?>
                    <?php elseif(in_array(295, $_categoryIds)): ?>
                        <?php echo $this->getLayout()->createBlock('cms/block')->setBlockId('medicamento-sem-imagem-antimicrobianos')->toHtml(); ?>
                    <?php elseif(in_array(14, $_categoryIds) && in_array(28, $_categoryIds)): ?>
                        <?php echo $this->getLayout()->createBlock('cms/block')->setBlockId('medicamento-sem-imagem-genericos')->toHtml(); ?>
                    <?php elseif(in_array(28, $_categoryIds)): ?>
                        <?php echo $this->getLayout()->createBlock('cms/block')->setBlockId('medicamento-sem-imagem')->toHtml(); ?>
                    <?php else: ?>
                        <img id="product-collection-image-<?php echo $_product->getId(); ?>"
                             src="<?php echo $_helper->productAttribute($_product, $this->helper('catalog/image')->init($_product, 'small_image')->resize($_imgSize), 'small_image'); ?>"
                             alt="<?php echo $this->stripTags($this->getImageLabel($_product, 'small_image'), null, true) ?>" width="180px" height="180px" />
                    <?php endif; ?>
                </a>
                <h3 class="product-name">
                    <a href="<?php echo $_product->getProductUrl() ?>" title="<?php echo $this->stripTags($_product->getName(), null, true) ?>)">
                        <?php echo $this->helper('catalog/output')->productAttribute($_product, $_product->getName() , 'name') ?>
                    </a>
                </h3>
                <?php if ($_product->getTypeId() != "configurable") : ?>
                    <span class="product-sku">SKU: <?php echo $_product->getSku(); ?></span><br>
                <?php endif; ?>
                <?php echo $this->getPriceHtml($_product, true, '-widget-new-grid') ?>
                <div class="tier-price-desk">
                    <?php 
                        $_coreHelper = $this->helper('core'); 
                        $_taxHelper = $this->helper('tax');
                        $_store = $_product->getStore();
                        $_convertedFinalPrice = $_store->roundPrice($_store->convertPrice($_product->getFinalPrice()));
                        $_finalPrice = $_taxHelper->getPrice($_product, $_convertedFinalPrice);
                    ?>
                    <?php
                        $attribute = $_product->getResource()->getAttribute('tier_price');
                        if ($attribute) {
                            $attribute->getBackend()->afterLoad($_product);
                            $tierPrices = $_product->getTierPrice();
                            $j = 0;
                            $len = count($tierPrices);
                            foreach($tierPrices as $tierPrice) { ?>
                                <?php if ($j == 0 && $len > 1) {}else if ($j == $len - 1) { ?>
                                    <?php $_percent = $tierPrice["price"];?>
                                    <?php if ($this->getUseLinkForAsLowAs()): ?>
                                        <a href="<?php echo $_product->getProductUrl(); ?>" class="minimal-price-link">
                                    <?php else: ?>
                                        <span class="minimal-price-link">
                                    <?php endif ?>
                                    <span class="label"><?php echo "Compre " . round($tierPrice["price_qty"], 0) . " por " . $_coreHelper->formatPrice($tierPrice["price"], false) . " cada"?></span>
                                    <div class="arrow"></div>
                                    <span class="price" id="product-minimal-price-<?php echo $_id ?><?php echo $this->getIdSuffix() ?>">
                                        <?php echo round(100 - (100 * $tierPrice["price"]/$_finalPrice)) . "% OFF" ?>
                                    </span>
                                    <?php if ($this->getUseLinkForAsLowAs()): ?>
                                        </a>
                                    <?php else: ?>
                                        </span>
                                    <?php endif ?>
                                <?php } ?>
                                <?php $j++;
                            }
                        }
                    ?>
                </div>
                <div class="actions">
                    <?php if ($_product->isSaleable()): ?>
                        <button type="button" title="<?php echo $this->__('Add to Cart') ?>" class="button btn-cart" onclick="setLocation('<?php echo $this->getAddToCartUrl($_product) ?>')"><span><span><?php echo $this->__('Add to Cart') ?></span></span></button>
                    <?php else: ?>
                        <p class="availability out-of-stock"><span><?php echo $this->__('Out of stock') ?></span></p>
                    <?php endif; ?>
                </div>
            </li>
        <?php if ($i%$_columnCount==0 || $i==count($_products)): ?>
        </ul>
        <?php endif ?>
        <?php endforeach; ?>
        <script type="text/javascript">
            var jQuery=jQuery.noConflict();
            if (jQuery(".widget-multi-products").length){
                jQuery('body').addClass('multi-products');
            }
        </script>
    </div>
</div>
<?php endif; ?>
