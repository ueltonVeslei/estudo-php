<?php
/**
 * Magento
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Academic Free License (AFL 3.0)
 * that is bundled with this package in the file LICENSE_AFL.txt.
 * It is also available through the world-wide-web at this URL:
 * http://opensource.org/licenses/afl-3.0.php
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@magentocommerce.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade Magento to newer
 * versions in the future. If you wish to customize Magento for your
 * needs please refer to http://www.magentocommerce.com for more information.
 *
 * @category    design
 * @package     base_default
 * @copyright   Copyright (c) 2010 Magento Inc. (http://www.magentocommerce.com)
 * @license     http://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
 */
?>
<?php
/**
 * One page checkout payment methods
 *
 * @see Mage_Checkout_Block_Onepage_Payment_Methods
 */
?>

<div class="sp-methods" id="checkout-payment-method-load">
	<?php
		foreach ($this->getMethods() as $_method):
			$_code = $_method->getCode();
	?>
		<div class="sp-method">
			<div class="sp-method-header">
				<?php if( sizeof($this->getMethods()) > 1 ):  /*  onclick="payment.switchMethod('<?php echo $_code ?>')" */ ?>
					<input id="p_method_<?php echo $_code ?>"<?php if($_code == 'paypal_standard' && strpos(Mage::getSingleton('checkout/session')->getQuote()->getShippingAddress()->getShippingMethod(),'matrixrate_matrixrate') === false): ?> onclick="return verifySelectedShipping();"<?php endif; ?> value="<?php echo $_code ?>" type="radio" name="payment[method]" title="<?php echo $this->htmlEscape($_method->getTitle()) ?>" class="radio payment_method_handle" />
				<?php else: ?>
					<span class="no-display"><input id="p_method_<?php echo $_code ?>"<?php if($_code == 'paypal_standard' && strpos(Mage::getSingleton('checkout/session')->getQuote()->getShippingAddress()->getShippingMethod(),'matrixrate_matrixrate') === false): ?> onclick="return verifySelectedShipping();"<?php endif; ?> value="<?php echo $_code ?>" type="radio" name="payment[method]" checked="checked" class="radio payment_method_handle" /></span>
				<?php endif; ?>
				<label for="p_method_<?php echo $_code ?>"><?php echo $_method->getTitle() ?> <?php echo $this->getMethodLabelAfterHtml($_method) ?></label>
			</div>

			<?php if ($html = $this->getPaymentMethodFormHtml($_method)): ?>
				<div class="sp-method-content">
					<style type="text/css">
						#payment_form_<?php echo $_code ?>_extra {
							display: none;
						}
					</style>
					<?php echo $html; ?>
				</div>
			<?php endif; ?>
		</div>
	<?php endforeach; ?>
	<?php if(Mage::App()->getStore()->getWebsiteId() != 10): ?>
	<div class="sp-method">
		<div class="sp-method-header">
			<input id="p_method_oipaggo" value="braspagcc" type="radio" name="payment[method]" title="Oi Paggo" 
				class="radio payment_method_handle" />
			<label for="p_method_oipaggo"><?php echo $this->__('Oi Paggo')?></label>
		</div>

		<div class="sp-method-content">
			<div id="payment_form_oipaggo">
				<p class="labelpaggo">
					Se você é cliente Oi Paggo, poderá utilizar seu celular para fazer este pagamento após finalizar a compra na tela.
				</p>
				<span class="imagem-paggo">
					<img src="<?php print $this->getSkinUrl('mw_onestepcheckout/images/paggo.png'); ?>" alt="Oi Paggo" />
				</span>
				<div class="clearer"></div>
			</div>
			<div id="payment_form_oipaggo_extra" style="display: none;">
				<?php $quote = Mage::getSingleton('checkout/session')->getQuote();?>
				<?php /*?>
				<input type="hidden" name="payment[numero_parcelas]" id="payment[numero_parcelas]" value="1" disabled="disabled"/>
	    		<input type="hidden" name="payment[valor_parcela]" id="payment[valor_parcela]" value="<?php echo number_format($quote->getGrandTotal(),2, '.', '');?>" disabled="disabled"/>
	    		<input type="hidden" name="payment[nome_bandeira]" id="payment[nome_bandeira]" value="oipaggo" disabled="disabled"/>
	    		<input type="hidden" name="payment[bandeira]" id="payment[bandeira]" value="55" disabled="disabled"/>
	    		<?php */ ?>
    		</div>
		</div> 
	</div>
	<?php endif ?>
</div>
<script type="text/javascript">
//<![CDATA[
<?php echo $this->getChildChildHtml('scripts'); ?>
payment.init();
//]]>
var payment_method_changed = -1;
if(payment_load()){
	$MW_Onestepcheckout(".payment_method_handle").unbind().click(function(){
		if(this.value != payment_method_changed){
			updatePaymentMethod(this.value);	
			payment_method_changed = this.value;
			// if($j(this).attr('id') == 'p_method_braspagcc') $j('#payment_form_braspagcc ul li:first input:first').click(); //$j('#payment_form_braspagcc input[type=radio]').attr('checked','')
			//$j('.parcelas-table input[type=radio]').attr('checked','');
			//$j('#card_data input:text,#card_data select').val('');

			//if($j(this).attr('id') == 'p_method_braspagcc'){
			//	$j("#payment_form_braspagcc").find('input:text, select').addClass('required-entry');
			//	$j("#payment_form_braspagcc input[type=radio]").addClass('validate-one-required-by-name');
			//}else{
			//	$j("#payment_form_braspagcc").find("input:text, select").removeClass().addClass("input-text");
			//	$j("#payment_form_braspagcc input[type=radio]").removeClass('validate-one-required-by-name');
			//	$j("#payment_form_braspagcc div.validation-advice").remove();
			//}
		}

	});

	//var braspagCurrent = false;
	//$j('#checkout-payment-method-load dd fieldset').children().show();
	//$j('#payment_form_braspagcc input, #payment_form_braspagcc select').attr('disabled','').click(function(){
	//	if(braspagCurrent){
	//		$j('#p_method_braspagcc').click();
	//	}
	//	braspagCurrent = true;
	//});

	//$j('#bandeiras input:first').click();
	//$j('#bandeiras div').removeClass();
	//$j('#bandeiras div:first').addClass('ativo');

	//$MW_Onestepcheckout('#p_method_braspagboleto').click();
	$MW_Onestepcheckout('.sp-method .sp-method-header input:radio').live('click',function(){
		$MW_Onestepcheckout('.sp-method').removeClass('ativo').find('.sp-method-content').find('input, select').attr('disabled', true);
		$MW_Onestepcheckout('.sp-method .sp-method-content div').each(function(){
			if(/^payment_form_([A-Za-z0-9_]*)_extra$/.test($MW_Onestepcheckout(this).attr('id')) && $MW_Onestepcheckout(this).attr('id') != 'payment_form_paypal_standard_extra'){
				$MW_Onestepcheckout(this).hide();
			}
		});

		var flagname = ($MW_Onestepcheckout(this).attr('id') == 'p_method_oipaggo')? 'oipaggo':$MW_Onestepcheckout(this).val();

		
		$MW_Onestepcheckout(this).parent('.sp-method-header')
								 .parent('.sp-method').addClass('ativo')
								 .find('.sp-method-content')
								 .find('#payment_form_'+flagname+'_extra')
								 .find('input, select')
								 .removeAttr('disabled');
		 if(flagname == 'braspagcc'){
			 $MW_Onestepcheckout('#payment_form_'+flagname+'_extra').show();
		 }

		 if(flagname != 'paypal_standard'){
			 $MW_Onestepcheckout('#payment_form_paypal_standard_extra').hide();
		 }
	});

}

$MW_Onestepcheckout('#p_method_oipaggo').click(function(){
	document.getElementById('payment[nome_bandeira]').value = 'oipaggo';
	document.getElementById('payment[valor_parcela]').value = '<?php echo number_format($quote->getGrandTotal(),2, '.', '');?>';
	document.getElementById('payment[bandeira]').value = '55';
	document.getElementById('payment[numero_parcelas]').value = '1';
});

function verifySelectedShipping(){
	if($j('#co-shipping-method-form input:checked').length > 0){
		alert('O método de envio que você escolheu não pode ser usado com o PayPal, por favor selecione outro método de envio.');
		return false;
	}
}
	//dua vao dashboart nhu updateshippingmethod()
	// function updatePaymentMethod(value)
	// {
		// //msg = "Loadding ...";
		// //$MW_Onestepcheckout('#checkout-review-load').html(msg);	// #checkout-review-load: id cua? bang? tong? tie`n, lenh .html(msg) cho phep gi lai. noi dung cua id voi'noi dung chua' trong bien $msg
		// $MW_Onestepcheckout('#loading-mask').css('display','block');
		// $MW_Onestepcheckout('.btn-checkout').attr('disabled','disabled');
		// $MW_Onestepcheckout.ajax({
		   // type: "POST",
		   // url: "<?php echo Mage::getUrl('onestepcheckout/index/updatepaymentmethod')?>",
		   // data: "payment%5Bmethod%5D="+value,
		   // success: function(msg){
			// $MW_Onestepcheckout('#checkout-review-load').html(msg);
			// $MW_Onestepcheckout('#loading-mask').css('display','none');
			// $MW_Onestepcheckout('.btn-checkout').removeAttr('disabled');
		   // }
		 // });
	// }
	</script>
