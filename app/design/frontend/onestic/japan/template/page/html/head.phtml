<?php
/**
 * Magento
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Academic Free License (AFL 3.0)
 * that is bundled with this package in the file LICENSE_AFL.txt.
 * It is also available through the world-wide-web at this URL:
 * http://opensource.org/licenses/afl-3.0.php
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@magento.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade Magento to newer
 * versions in the future. If you wish to customize Magento for your
 * needs please refer to http://www.magento.com for more information.
 *
 * @category    design
 * @package     base_default
 * @copyright   Copyright (c) 2006-2017 X.commerce, Inc. and affiliates (http://www.magento.com)
 * @license     http://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
 */
?>
<meta http-equiv="Content-Type" content="<?php echo $this->getContentType() ?>" />
<?php
$routeName = Mage::app()->getRequest()->getRouteName();
$identifier = Mage::getSingleton('cms/page')->getIdentifier();
?>
<?php if($routeName == 'cms' && $identifier == 'home') { ?>
    <title><?php echo $this->getTitle() ?></title>
<?php } else { ?>
    <title><?php echo $this->getTitle() . " | Farma Delivery"    ?></title>
<?php } ?>
<meta name="description" content="<?php echo htmlspecialchars($this->getDescription()) ?>" />
<meta name="robots" content="<?php echo htmlspecialchars($this->getRobots()) ?>" />

<?php
$currentUrl = Mage::helper('core/url')->getCurrentUrl();
$url = Mage::getSingleton('core/url')->parseUrl($currentUrl);
$path = $url->getPath();
$product = Mage::registry('current_product');
?>

<link rel="alternate" hreflang="ja" href="https://japan.farmadelivery.com.br<?php if ($product == null) { echo $path; } else{ echo '/'.$product->getUrlPath(); } ?>" />
<link rel="alternate" hreflang="pt-br" href="https://www.farmadelivery.com.br<?php if ($product == null) { echo $path; } else{ echo '/'.$product->getUrlPath(); }?>" />
<link rel="alternate" hreflang="x-default" href="https://www.farmadelivery.com.br<?php if ($product == null) { echo $path; } else{ echo '/'.$product->getUrlPath(); } ?>" />

<?php $product = Mage::registry('current_product');
if ($product): ?>
    <meta property="og:title" content="<?php echo $product->getName(); ?>" />
    <meta property="og:type" content="product" />
    <meta property="og:url" content="<?php echo $this->helper('catalog/product')->getProductUrl($product); ?>" />
    <meta property="og:image" content="<?php echo $this->helper('catalog/image')->init($product, 'image')->resize(300, 300); ?>" />
    <meta property="og:description" content="<?php echo strip_tags($product->getShortDescription()); ?>" />
    <meta property="og:site_name" content="<?php echo Mage::app()->getStore()->getName() ?>" />
<?php endif; ?>

<?php
$actionName = $this->getAction()->getFullActionName();
// Verifica se é a category page view para montar o rel prev, next e canonical
if ($actionName == 'catalog_category_view')
{
    $category = Mage::registry('current_category');
    $prodCol = $category->getProductCollection()->addAttributeToFilter('status', 1)->addAttributeToFilter('visibility', array('in' => array(Mage_Catalog_Model_Product_Visibility::VISIBILITY_IN_CATALOG, Mage_Catalog_Model_Product_Visibility::VISIBILITY_BOTH)));
    $tool = $this->getLayout()->createBlock('page/html_pager')->setLimit($this->getLayout()->createBlock('catalog/product_list_toolbar')->getLimit())->setCollection($prodCol);
    $prevLink = false;
    $nextLink = false;
    if ($tool->getCollection()->getSelectCountSql()) {
        if ($tool->getLastPageNum() > 1) {
            if (!$tool->isFirstPage()) {
                $prevLink = true;
                if ($tool->getCurrentPage() == 2) {
                    $url = explode('?', $tool->getPreviousPageUrl());
                    $prevUrl = @$url[0];
                }
                else {
                    $prevUrl = $tool->getPreviousPageUrl();
                }
            }
            if (!$tool->isLastPage()) {
                $nextLink = true;
                $nextUrl = $tool->getNextPageUrl();
            }
        }
    }
    // inserindo link prev e next
    if ($prevLink) echo '<link rel="prev" href="' . $prevUrl . '" />';
    if($_GET['p'] == 1) {
        echo '<link rel="canonical" href="' . strtok(Mage::helper('core/url')->getCurrentUrl(),'?') . '" />';
    }else{
        $urlFinal = rtrim(Mage::helper('core/url')->getCurrentUrl(), '/');
        echo '<link rel="canonical" href="' . $urlFinal . '" />';
    }
    if ($nextLink) echo '<link rel="next" href="' . $nextUrl . '" />';

}
// else if product view
else if($actionName == 'catalog_product_view') {
    $_product = Mage::registry('current_product');
    if ($_product) {
        $keyProduct = $_product->getUrlKey();
    }
    $currentLink = 'https://www.farmadelivery.com.br/'. $keyProduct;
    if ($currentLink) echo '<link rel="canonical" href="' . $currentLink . '" />';
}


// configuração Konduto
if ($actionName == 'customer_account_forgotpassword'){ ?>

    <!-- Página de 'Esqueci minha senha' -->
    <meta name="kdt:page" content="password-reset">

<?php }elseif($actionName == 'checkout_onepage_index') {?>

    <!-- Processo de checkout -->
    <meta name="kdt:page" content="checkout">

<?php }elseif($actionName == 'catalog_product_view'){ ?>

    <?php $product = Mage::registry('current_product'); ?>
    <!-- Detalhe de produto -->
    <?php if ($product): ?>
        <meta name="kdt:page" content="product">
        <meta name="kdt:product" content="sku=<?php echo $product->getSku(); ?>, name=<?php echo $product->getName(); ?>, description=<?php echo strip_tags($product->getShortDescription()); ?>, brand=<?php echo $product->getAttributeText('manufacturer'); ?>">
    <?php endif; ?>

<?php }elseif($actionName == 'catalogsearch_result_index'){ ?>

    <!-- Resultado de pesquisa -->
    <meta name="kdt:page" content="search">
    <meta name="kdt:search" content="<?php echo ($this->getHeaderText() || $this->getHeaderText() === false) ? $this->getHeaderText() : $this->helper('catalogsearch')->getEscapedQueryText() ?>">
    <meta name="kdt:date" content="<?php echo date('Y-m-d H:i:s'); ?>">

<?php }elseif($actionName == 'checkout_cart_index') {?>

    <!-- Carrinho -->
    <meta name="kdt:page" content="cart">

<?php }elseif($actionName == 'customer_account_login') {?>

    <!-- Account Login -->
    <meta name="kdt:page" content="account-login">

<?php }elseif($actionName == 'customer_account_create') {?>

    <!-- Account Create -->
    <meta name="kdt:page" content="account-create">

<?php }elseif($actionName == 'catalog_category_view') {?>

    <!-- Detalhe de produto -->
    <?php $category = Mage::registry('current_category'); ?>
    <?php if ($category): ?>
        <meta name="kdt:page" content="category">
        <meta name="kdt:category" content="name=<?php echo $category->getName(); ?>">
    <?php endif; ?>

<?php } ?>

<?php
if(Mage::getSingleton('customer/session')->isLoggedIn()): ?>
    <?php
        $customerData = Mage::getSingleton('customer/session')->getCustomer();
    ?>
    <script type="text/javascript">
        var customerID = "<?php echo $customerData->getEmail(); ?>"; // define o ID do cliente
        (function() {
            var period = 300;
            var limit = 20 * 1e3;
            var nTry = 0;
            var intervalID = setInterval(function() { // loop para retentar o envio
                var clear = limit/period <= ++nTry;
                if ((typeof(Konduto) !== "undefined") &&
                    (typeof(Konduto.setCustomerID) !== "undefined")) {
                    window.Konduto.setCustomerID(customerID); // envia o ID para a Konduto
                    clear = true;
                }
                if (clear) {
                    clearInterval(intervalID);
                }
            }, period);
        })(customerID);
    </script>
<?php endif;?>


<link rel="icon" href="<?php echo $this->getFaviconFile(); ?>" type="image/x-icon" />
<link rel="shortcut icon" href="<?php echo $this->getFaviconFile(); ?>" type="image/x-icon" />

<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=Roboto+Condensed" rel="stylesheet" type="text/css">

<?php echo $this->getCssJsHtml() ?>

<!--[if lt IE 7]>
<script type="text/javascript">
//<![CDATA[
    var BLANK_URL = '<?php echo $this->helper('core/js')->getJsUrl('blank.html') ?>';
    var BLANK_IMG = '<?php echo $this->helper('core/js')->getJsUrl('spacer.gif') ?>';
//]]>
</script>
<![endif]-->


<?php echo $this->getChildHtml() ?>
<?php echo $this->helper('core/js')->getTranslatorScript() ?>
<?php echo $this->getIncludes() ?>

<?php if(Mage::getBlockSingleton('page/html_header')->getIsHomePage()): ?>
	<script type="application/ld+json">
	{
		"@context": "http://schema.org",
		"@type": "Pharmacy",
		"name": "Farma Delivery",
		"url": "https://www.farmadelivery.com.br/",
		"image":
		"https://www.farmadelivery.com.br/skin/frontend/FarmaDelivery/nova_farma/images/logomain.png",
		"address": "Rua das Hortênsias, 1204, Jardim do Estádio, Santo André/SP, Cep 09175-500",
		"openingHours": "Seg-Sex 08:15-19:45 / Sáb 08:15-15:45",
		"telephone" : "+55 (11) 4972-8277",
		"sameAs" : [
			"https://www.facebook.com/FARMADELIVERY/",
			"https://www.instagram.com/farmadelivery/",
			"https://twitter.com/farmadelivery",
			"https://www.youtube.com/user/FarmaDelivery",
			"https://www.linkedin.com/company/farma-delivery-drogaria/"
		]
	}
	</script>
	<script type="application/ld+json">
	{
		"@context": "http://schema.org",
		"@type": "WebSite",
		"name": "Farma Delivery",
		"url": " https://www.farmadelivery.com.br/",
		"potentialAction": {
			"@type": "SearchAction",
			"target": "https://www.farmadelivery.com.br/catalogsearch/result/?q={search_term_string}",
			"query-input": "required name=search_term_string"
		}
	}
	</script>
<?php endif; ?>