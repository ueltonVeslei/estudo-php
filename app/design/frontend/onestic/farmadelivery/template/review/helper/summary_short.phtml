<?php
/**
 * Magento
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Academic Free License (AFL 3.0)
 * that is bundled with this package in the file LICENSE_AFL.txt.
 * It is also available through the world-wide-web at this URL:
 * http://opensource.org/licenses/afl-3.0.php
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@magento.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade Magento to newer
 * versions in the future. If you wish to customize Magento for your
 * needs please refer to http://www.magento.com for more information.
 *
 * @category    design
 * @package     base_default
 * @copyright   Copyright (c) 2006-2017 X.commerce, Inc. and affiliates (http://www.magento.com)
 * @license     http://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
 */
?>

<?php

$reviews = Mage::getModel('review/review')->getCollection()
    ->addStoreFilter(Mage::app()->getStore()->getId())
    ->addEntityFilter('product', $this->getProduct()->getId())
    ->addStatusFilter(Mage_Review_Model_Review::STATUS_APPROVED)
    ->setDateOrder()
    ->addRateVotes();

?>

<?php if ($this->getReviewsCount()): ?>
    <?php
    $total = 0;
    foreach($reviews as $review)
    {
        /** @var Mage_Rating_Model_Resource_Rating_Option_Vote_Collection $votes */
        $votes = $review->getRatingVotes();

        foreach($votes as $vote)
        {
            $total += $vote->getPercent();
        }
        $avg = $total / $this->getReviewsCount();
    }
    ?>
    <div class="ratings">
        <?php if ($this->getReviewsCount()):?>
            <div class="rating-box">
                <div class="rating" style="width:<?php echo $avg ?>%"></div>
            </div>
        <?php endif;?>
        <span class="amount">
            <a href="#customer-reviews">
                <?php if($this->getReviewsCount()>1) { ?>
                    <?php echo $this->__('%d Opiniões', $this->getReviewsCount()) ?>
                <?php }else { ?>
                    <?php echo $this->__('%d Opinião', $this->getReviewsCount()) ?>
                <?php } ?>
            </a>
        </span>
    </div>
<?php endif; ?>
