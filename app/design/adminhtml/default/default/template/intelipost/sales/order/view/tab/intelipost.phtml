<?php
/**
 * Magento
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Academic Free License (AFL 3.0)
 * that is bundled with this package in the file LICENSE_AFL.txt.
 * It is also available through the world-wide-web at this URL:
 * http://opensource.org/licenses/afl-3.0.php
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@magentocommerce.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade Magento to newer
 * versions in the future. If you wish to customize Magento for your
 * needs please refer to http://www.magentocommerce.com for more information.
 *
 * @category    design
 * @package     default_default
 * @copyright   Copyright (c) 2013 Magento Inc. (http://www.magentocommerce.com)
 * @license     http://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
 */
?>
<?php $_order = $this->getOrder()?>
<div class="box-left">
        <!--Shipping Method-->
        <div class="entry-edit">
            <div class="entry-edit-head">
                <h4 class="icon-head head-shipping-method"><?php echo Mage::helper('quote')->__('Intelipost Quote Informations') ?></h4>
            </div>
            <fieldset>
                <?php  if ($_order->getTracksCollection()->count()) : ?>
                <a href="#" id="linkId" onclick="popWin('<?php echo $this->helper('shipping')->getTrackingPopupUrlBySalesModel($_order) ?>','trackorder','width=800,height=600,resizable=yes,scrollbars=yes')" title="<?php echo $this->__('Track Order') ?>"><?php echo $this->__('Track Order') ?></a>
                <br/>
                <?php endif; ?>
                <?php if ($_order->getShippingDescription()): ?>
                    <strong><?php echo $this->escapeHtml($_order->getShippingDescription()) ?></strong>

                    <?php if ($this->helper('tax')->displayShippingPriceIncludingTax()): ?>
                        <?php $_excl = $this->displayShippingPriceInclTax($_order); ?>
                    <?php else: ?>
                        <?php $_excl = $this->displayPriceAttribute('shipping_amount', false, ' '); ?>
                    <?php endif; ?>
                    <?php $_incl = $this->displayShippingPriceInclTax($_order); ?>

                    <?php echo $_excl; ?>
                    <?php if ($this->helper('tax')->displayShippingBothPrices() && $_incl != $_excl): ?>
                        (<?php echo $this->__('Incl. Tax'); ?> <?php echo $_incl; ?>)
                    <?php endif; ?>
                    <?php if ($this->getQuoteId()) : ?>
                    <div>
                        <p>
                            <?php //echo Mage::helper('basic')->getIntelipostMethodName($this->basicOrders->getDeliveryMethodId(), 'quote')?>
                            <?php echo Mage::helper('basic')->getMethodName($this->basicOrders->getDeliveryMethodId())?>
                        </p>
                        <p></p>                       
                        <p>                        
                            <?php echo Mage::helper('quote')->__('Quote:')?> <?php echo $this->getQuoteId() ?> (<a href="<?php echo $this->getIntelipostQuoteUrl()?>" title="ir para intelipost" target="_blank">Link</a>) - <?php echo Mage::helper('quote')->__('Shipping Method ID(intelipost):')?> <?php echo $this->getDeliveryMethodId() ?>
                        
                        </p>
                    </div>
                <?php endif; ?>
                <?php if ($this->getFallBack() || Mage::helper('quote')->getConfigData('use_requote')) : ?>
                    <div>
                        <button type="button" onclick="intelipostQuote('<?php echo Mage::helper("adminhtml")->getUrl('adminhtml/quote_quote/requestQuote/order_id/', array("order_id"=>$_order->getId(), "intelipost_quote_id"=>$this->getQuoteId()))?>')"><?php echo Mage::helper('quote')->__('Request Quote')?></button>
                    </div>
                <?php endif; ?>
                <?php else: ?>
                    <?php echo $this->helper('sales')->__('No shipping information available'); ?>
                <?php endif; ?>
            </fieldset>
        </div>

        <?php if ($this->getQuoteId()) : ?>

        <form name="quote_volumes_qty" id="quote_volumes_qty">
            <div class="entry-edit">
                <div class="entry-edit-head">
                    <h4 class="icon-head head-shipping-method"><?php echo Mage::helper('quote')->__('Volumes da cotação') ?></h4>
                </div>
                <fieldset>
                    <label for="qty_volumes">Quantidade de Volumes:</label>
                    <input type="text" value="<?php echo $this->getVolumes()?>" name="qty_volumes" id="qty_volumes" />

                    <div style="margin: 0 auto">
                    <button type="button" onclick="updateVolumes()"><?php echo Mage::helper('quote')->__('Update Volumes')?></button>
                    </div> 
                </fieldset>
                <input type="hidden" value="<?php echo $_order->getId() ?>" name="order_id" />
            </div>
        </form>

    <?php endif; ?>
        <div class="entry-edit">
            <div class="entry-edit-head">
                <h4 class="icon-head head-shipping-method"><?php echo Mage::helper('quote')->__('Intelipost Order Sending Details') ?></h4>
            </div>
            <fieldset>
                <div><?php echo Mage::helper('quote')->__('Link Pedido Intelipost: ')?>: <a href="<?php echo $this->getIntelipostOrderUrl()?>" title="ir para intelipost" target="_blank">Link</a></div>
                <div><?php echo Mage::helper('quote')->__('Tracking Code')?>: <?php echo $this->getOrderTrackingCode() ?></div>
                <div><?php echo Mage::helper('quote')->__('Invoice Number (NFE)')?>: <?php echo $this->getOrderNfes() ?></div>
                <div><?php echo Mage::helper('quote')->__('CFOP')?>: <?php echo $this->getNfesCfop() ?></div>
                <div><?php echo Mage::helper('quote')->__('Chave')?>: <?php echo $this->getNfesKey() ?></div>
                <div><?php echo Mage::helper('quote')->__('Série')?>: <?php echo $this->getNfesSeries() ?></div>
                <div><?php echo Mage::helper('quote')->__('Data de Faturamento')?>: <?php echo $this->getNfesCreatedAt() ?></div>
                <div style="margin-top:5px">
                    <table cellspacing="2" cellpadding="2" class="data border" border="1" id="act_intelipost" style="width:100%;">
                        <col width="250" />
                        <col width="250" />
                        <thead>
                            <tr class="headings">            
                                <th colspan="2" style="text-align:center"><?php echo Mage::helper('quote')->__('Controle Manual de Pedidos') ?></th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="2" style="text-align:center; padding:5px"><button type="button" onclick="setLocation('<?php echo Mage::helper('adminhtml')->getUrl('adminhtml/push_orders/send', array('order_id' => $_order->getId(), 'source' => 'magento_order')) ?>')"><?php echo Mage::helper('quote')->__('Criar Pedido de Envio')?></button></td>
                            </tr>
                            <tr>
                                <td colspan="2" style="text-align:center; padding:5px"><button type="button" onclick="setLocation('<?php echo Mage::helper('adminhtml')->getUrl('adminhtml/push_orders/updateNfeData', array('order_id' => $_order->getId(), 'source' => 'magento_order')) ?>')"><?php echo Mage::helper('quote')->__('Atualizar Notas Fiscais')?></button></td>
                            </tr>
                            <tr>
                                <td colspan="2" style="text-align:center; padding:5px"><button type="button" onclick="setLocation('<?php echo Mage::helper('adminhtml')->getUrl('adminhtml/push_orders/readyForShipment', array('order_id' => $_order->getId(), 'source' => 'magento_order')) ?>')"><?php echo Mage::helper('quote')->__('Pronto para despacho')?></button></td>
                            </tr>
                            <tr>
                                <td colspan="2" style="text-align:center; padding:5px"><button type="button" onclick="setLocation('<?php echo Mage::helper('adminhtml')->getUrl('adminhtml/push_orders/shipment', array('order_id' => $_order->getId(), 'source' => 'magento_order')) ?>')"><?php echo Mage::helper('quote')->__('Despachado')?></button></td>
                            </tr>
                            <!--<tr>
                                <td colspan="2" style="text-align:center; padding:5px"><button type="button" onclick="setLocation('<?php //echo Mage::helper('adminhtml')->getUrl('push/adminhtml_orders/updateTracking', array('increment_id' =>$_order->getIncrementId(),'order_id' => $_order->getId())) ?>')"><?php //echo Mage::helper('quote')->__('Atualizar Rastreamento')?></button></td>
                            </tr>-->
                        </tbody>
                    </table>
                </div>
            </fieldset>
        </div>

        <form name="change_method" id="change_method">
            <div class="entry-edit">
                <div class="entry-edit-head">
                    <h4 class="icon-head head-shipping-method"><?php echo Mage::helper('quote')->__('Change Shipping Method') ?></h4>
                </div>
                <fieldset>
                    <?php $this->getShippingRates() ?>
                    
                    <div style="margin-bottom:3px">
                        <table cellspacing="0" class="data border" id="sm_table" style="width:100%;">
                        <col width="200" />
                        <col width="140" />
                        <col width="140" />
                        <thead>
                            <tr class="headings">            
                                <th style="text-align:center"><?php echo Mage::helper('quote')->__('Método') ?></th>
                                <th style="text-align:center"><?php echo Mage::helper('quote')->__('Prazo') ?></th>
                                <th style="text-align:center"><?php echo Mage::helper('quote')->__('Custo') ?></th>             
                            </tr>
                        </thead>
                        
                        <tbody>
                        <?php foreach ($this->rates as $rate) : ?>
                        <tr>
                            <td>    
                            <input type="radio" name="shipping_methods" value="<?php echo $rate['code']?>"><?php echo $rate['description']?>
                            </td>
                            <td align="center">
                            <?php echo $rate['estimated_days']?>
                            </td>                            
                            <td align="center">
                            <?php echo $rate['cost']?>
                            </td>
                        </tr>
                        <?php endforeach; ?>
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="8" class="a-right"></td>
                            </tr>
                        </tfoot>
                    </table>
                    </div>
                

                    <div style="margin-bottom:5px">
                        <label style="display: inline-block; width: 140px; text-align: left;" for='other_method'>Outro método: </label>
                        <input type='text' name='other_method' id='other_method'/>                        
                    </div>

                    <div style="margin-bottom:5px">
                        <label style="display: inline-block; width: 140px; text-align: left;" for='other_method_id'>Id Outro método: </label>
                        <input type='text' name='other_method_id' id='other_method_id'/>
                    </div>
                    <div style="margin: 0 auto">
                    <button type="button" onclick="updateQuote()"><?php echo Mage::helper('quote')->__('Update Quote')?></button>
                    </div>                    
                </fieldset>
            </div>
            <input type="hidden" value="<?php echo $_order->getIncrementId() ?>" name="order_id" />
            <input type="hidden" value="<?php echo $this->getQuoteId() ?>" name="intelipost_quote_id" />
        </form>

        <form name="update_status" id="update_status">
            <div class="entry-edit">
                <div class="entry-edit-head">
                    <h4 class="icon-head head-shipping-method"><?php echo Mage::helper('quote')->__('Alterar status do pedido') ?></h4>
                </div>
                <fieldset>
                    <div style="margin-bottom:3px">
                        <label style="display: inline-block; width: 140px; text-align: left;" for="order_statuses">Status Magento: </label>
                        <select name="order_statuses">
                            <option value="0">
                                Selecione um dos status disponíveis
                            </option>
                            <?php foreach ($this->getOrderStatuses() as $status) : ?>
                                <option value="<?php echo $status['value']?>" <?php if ($_order->getStatus() == $status['value']) echo 'selected'?> >
                                    <?php echo $status['label'] ?>
                                </option>
                            <?php endforeach; ?>
                        </select>
                    </div>

                    <div style="margin-bottom:5px">
                        <label style="display: inline-block; width: 140px; text-align: left;" for="intelipost_statuses">Status Intelipost: </label>
                        <select name="intelipost_statuses">
                            <option value="0">
                                Selecione um dos status disponíveis
                            </option>
                            <?php foreach ($this->getIntelipostStatuses() as $status) : ?>
                                <option value="<?php echo $status['value']?>" <?php if ($this->basicOrders->getStatus() == $status['value']) echo 'selected'?> >
                                    <?php echo $status['label'] ?>
                                </option>
                            <?php endforeach; ?>
                        </select>
                    </div>

                    <div style="margin: 0 auto">
                    <button type="button" onclick="updateStatus()"><?php echo Mage::helper('quote')->__('Update Status')?></button>
                    </div> 
                </fieldset>
            </div>
            <input type="hidden" value="<?php echo $_order->getIncrementId() ?>" name="order_id" />
        </form>
    </div>
<script type="text/javascript">
//<![CDATA[
    /**
     * Retrieve gift options tooltip content
     */

     var formId = '#change_method';
     var form_update_status = '#update_status';
     var form_update_volumes = '#quote_volumes_qty';

     function updateQuote()
     {        
        url = "<?php echo Mage::helper('adminhtml')->getUrl('adminhtml/quote_quote/updateQuote')?>";
        var form = $$(formId)[0];

        new Ajax.Request(url, {
          method: 'post',
          //dataType: 'json',
          parameters: form.serialize(true),
          onSuccess: successFunc,
          onFailure:  failureFunc
          });

        function successFunc(response)
        {              
            location.reload();
        }

        function failureFunc(response)
        {
            alert('Não foi possível atualizar o método de entrega.');
        }
     }

     function updateVolumes()
     {
        url = "<?php echo Mage::helper('adminhtml')->getUrl('adminhtml/quote_quote/updateVolumes')?>";
        var form = $$(form_update_volumes)[0];

        new Ajax.Request(url, {
          method: 'post',
          //dataType: 'json',
          parameters: form.serialize(true),
          onSuccess: successFunc,
          onFailure:  failureFunc
          });

        function successFunc(response)
        {   
            location.reload();
        }

        function failureFunc(response)
        {
            alert('Não foi possível atualizar a quantidade de volumes desta cotação.');
        }
     }

     function updateStatus()
     {        
        url = "<?php echo Mage::helper('adminhtml')->getUrl('adminhtml/quote_quote/updateStatus')?>";
        var form = $$(form_update_status)[0];

        new Ajax.Request(url, {
          method: 'post',
          //dataType: 'json',
          parameters: form.serialize(true),
          onSuccess: successFunc,
          onFailure:  failureFunc
          });

        function successFunc(response)
        {   
            location.reload();
        }

        function failureFunc(response)
        {
            alert('Não foi possível atualizar status do Pedido e/ou da Intelipost.');
        }
     }

     function createOrder(order_id)
     {
        url = "<?php echo Mage::helper('adminhtml')->getUrl('adminhtml/quote_quote/createOrder'); ?>";

        new Ajax.Request(url, {
          method: 'post',
          //dataType: 'json',
          parameters: {data1: order_id},
          onSuccess: successFunc,
          onFailure:  failureFunc
          });

        function successFunc(response)
        {   
            location.reload();
        }

        function failureFunc(response)
        {
            alert('Não foi possível atualizar status do Pedido e/ou da Intelipost.');
        }
     }
     function intelipostQuote(url)
     {
        var load = $$('#loading-mask')[0];
        load.show();
        setLocation(url);
     }
//]]>
</script>